<!-- index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Sonno x World</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <script defer src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.13.0/dist/tf.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
  <style>
    :root {
      --bg:#030509;
      --pane:#0c1119cc;
      --glow:#13435e;
      --accent:#4ad6ff;
      --text:#f2f4f8;
      --muted:#7f8da8;
      --radius:18px;
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      font-family:'Inter',system-ui;
      color:var(--text);
      background:radial-gradient(circle at 15% -20%,rgba(52,85,124,0.35) 0%,transparent 55%),
                 radial-gradient(circle at 92% -15%,rgba(34,123,173,0.28) 0%,transparent 45%),
                 #02060c;
      min-height:100vh;
      display:flex;
      justify-content:center;
    }
    main{width:min(1120px,100%);padding:56px 24px 96px;display:flex;flex-direction:column;gap:40px;}
    header{text-transform:uppercase;display:flex;flex-direction:column;gap:14px;letter-spacing:0.04em;}
    header span{font-size:15px;color:var(--muted);}
    header h1{font-size: clamp(42px, 6vw, 72px);font-weight:500;}
    .panel{background:rgba(7,12,19,0.82);border:1px solid rgba(255,255,255,0.08);border-radius:var(--radius);
      padding:28px;box-shadow:0 32px 80px rgba(5,12,24,0.55);backdrop-filter:blur(24px);}
    .camera-wrap{display:grid;gap:18px;justify-items:center;}
    .camera-frame{position:relative;width:min(720px,100%);aspect-ratio:16/9;border-radius:var(--radius);
      overflow:hidden;background:rgba(8,12,18,0.8);border:1px solid rgba(255,255,255,0.06);}
    video{width:100%;height:100%;object-fit:cover;transform:scaleX(-1);}
    .overlay{
      position:absolute;inset:0;pointer-events:none;display:flex;align-items:flex-end;justify-content:space-between;
      padding:16px;background:linear-gradient(180deg,transparent 55%,rgba(3,5,9,0.72) 100%);
    }
    .count{
      font-size:38px;font-weight:600;display:flex;align-items:flex-end;gap:12px;
      text-shadow:0 0 24px rgba(74,214,255,0.75);
    }
    .status{font-size:13px;color:var(--muted);text-align:center;}
    .primary-btn{
      padding:14px 24px;border-radius:999px;border:0;font-weight:600;font-size:14px;
      text-transform:uppercase;letter-spacing:0.08em;
      background:linear-gradient(135deg,#0b8dff,#52efff);color:#05080f;
      cursor:pointer;transition:transform .15s ease,box-shadow .2s ease;
    }
    .primary-btn[disabled]{opacity:.55;cursor:not-allowed;filter:grayscale(0.6);}
    .primary-btn:hover:not([disabled]){transform:translateY(-2px);box-shadow:0 18px 36px rgba(82,239,255,0.3);}
    .songs{
      display:grid;
      gap:20px;
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
    }
    .song-card{
      position:relative;padding:24px;border-radius:var(--radius);
      background:rgba(6,11,18,0.8);border:1px solid rgba(255,255,255,0.06);
      display:flex;flex-direction:column;gap:18px;
    }
    .song-card h3{font-size:18px;font-weight:600;}
    .song-card p{color:var(--muted);font-size:14px;line-height:1.4;}
    .song-card button{
      align-self:flex-start;padding:12px 20px;border-radius:999px;border:1px solid rgba(255,255,255,0.12);
      background:transparent;color:var(--text);font-weight:500;cursor:pointer;
      transition:background .2s ease,color .2s ease,border-color .2s ease;
    }
    .song-card button:is(:hover,.is-active){
      background:linear-gradient(130deg,rgba(31,140,255,0.35),rgba(82,239,255,0.28));
      border-color:rgba(74,214,255,0.8);color:#0c1119;
    }
    .song-card.active{border-color:rgba(74,214,255,0.9);box-shadow:0 0 0 1px rgba(74,214,255,0.3);}
    .layers-indicator{font-size:13px;color:var(--muted);}
    footer{font-size:12px;color:var(--muted);text-align:center;}
    @media(max-width:600px){
      .panel{padding:22px;}
      .count{font-size:30px;}
    }
  </style>
</head>
<body>
  <main>
    <header>
      <span>immersive audio showcase</span>
      <h1>Sonno x World</h1>
    </header>

    <section class="panel camera-wrap">
      <div class="camera-frame">
        <video id="webcam" autoplay playsinline muted></video>
        <div class="overlay">
          <div class="count"><span id="people-count">0</span><small>people in frame</small></div>
          <div class="layers-indicator" id="layers-indicator">Core track only</div>
        </div>
      </div>
      <button id="start-camera" class="primary-btn">Start camera</button>
      <p class="status" id="camera-status">Camera idle. Press “Start camera” to begin detection.</p>
    </section>

    <section class="panel">
      <h2 style="font-size:20px;margin-bottom:8px;">Pick a song</h2>
      <p style="color:var(--muted);font-size:14px;margin-bottom:22px;">
        Each selection mixes a core stem with up to three layers. Layers unlock automatically as more people appear.
      </p>
      <div class="songs">
        <article class="song-card" data-song-id="liminal-dawn"
                 data-core="assets/audio/liminal-dawn-core.mp3"
                 data-layer1="assets/audio/liminal-dawn-layer1.mp3"
                 data-layer2="assets/audio/liminal-dawn-layer2.mp3"
                 data-layer3="assets/audio/liminal-dawn-layer3.mp3">
          <h3>Liminal Dawn</h3>
          <p>Glasslike pads and gentle percussion, evolving into a shimmering uptempo groove.</p>
          <button type="button" class="select-song">Play Liminal Dawn</button>
        </article>

        <article class="song-card" data-song-id="midnight-parade"
                 data-core="assets/audio/midnight-parade-core.mp3"
                 data-layer1="assets/audio/midnight-parade-layer1.mp3"
                 data-layer2="assets/audio/midnight-parade-layer2.mp3"
                 data-layer3="assets/audio/midnight-parade-layer3.mp3">
          <h3>Midnight Parade</h3>
          <p>Neo-funk bass and syncopated claps morph into brass hits as the room fills up.</p>
          <button type="button" class="select-song">Play Midnight Parade</button>
        </article>

        <article class="song-card" data-song-id="pulse-shift"
                 data-core="assets/audio/pulse-shift-core.mp3"
                 data-layer1="assets/audio/pulse-shift-layer1.mp3"
                 data-layer2="assets/audio/pulse-shift-layer2.mp3"
                 data-layer3="assets/audio/pulse-shift-layer3.mp3">
          <h3>Pulse Shift</h3>
          <p>Minimal techno pulse that gains arps, leads, and vocal chops with every extra guest.</p>
          <button type="button" class="select-song">Play Pulse Shift</button>
        </article>
      </div>
    </section>

    <footer>Built for Sonno ∞ World — keep headphones handy.</footer>
  </main>

  <script>
    const video = document.getElementById('webcam');
    const startBtn = document.getElementById('start-camera');
    const statusEl = document.getElementById('camera-status');
    const countEl = document.getElementById('people-count');
    const layersEl = document.getElementById('layers-indicator');

    let model = null;
    let stream = null;
    let detectionTimer = null;
    let peopleCount = 0;

    class LoopPlayer {
      constructor(context, url) {
        this.context = context;
        this.url = url;
        this.buffer = null;
        this.source = null;
        this.gain = context.createGain();
        this.gain.connect(context.destination);
        this.gain.gain.value = 0;
      }
      async load() {
        const response = await fetch(this.url);
        if (!response.ok) throw new Error('Failed to load audio: ' + this.url);
        const data = await response.arrayBuffer();
        this.buffer = await this.context.decodeAudioData(data);
      }
      ensureSource() {
        if (this.source || !this.buffer) return;
        const node = this.context.createBufferSource();
        node.buffer = this.buffer;
        node.loop = true;
        node.connect(this.gain);
        node.start();
        this.source = node;
      }
      setActive(active) {
        this.ensureSource();
        const target = active ? 1 : 0;
        this.gain.gain.setTargetAtTime(target, this.context.currentTime, 0.12);
      }
      stop() {
        this.gain.gain.setValueAtTime(0, this.context.currentTime);
        if (this.source) {
          try { this.source.stop(); } catch (_) {}
          this.source.disconnect();
          this.source = null;
        }
      }
    }

    class SongLayers {
      constructor(context, card) {
        this.context = context;
        this.card = card;
        const { core, layer1, layer2, layer3 } = card.dataset;
        this.players = [
          new LoopPlayer(context, core),
          new LoopPlayer(context, layer1),
          new LoopPlayer(context, layer2),
          new LoopPlayer(context, layer3)
        ];
        this.ready = false;
      }
      async load() {
        if (this.ready) return;
        await Promise.all(this.players.map(p => p.load()));
        this.ready = true;
      }
      applyCount(count) {
        if (!this.ready) return;
        this.players.forEach((player, index) => {
          if (index === 0) {
            player.setActive(true);
            return;
          }
          const shouldPlay = count >= index;
          player.setActive(shouldPlay);
        });
      }
      stop() {
        this.players.forEach(player => player.stop());
      }
    }

    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const songs = new Map();
    let activeSong = null;

    document.querySelectorAll('.song-card').forEach(card => {
      const song = new SongLayers(audioContext, card);
      songs.set(card.dataset.songId, song);
      const button = card.querySelector('.select-song');
      button.addEventListener('click', async () => {
        try {
          await audioContext.resume();
          if (!song.ready) {
            button.textContent = 'Loading…';
            await song.load();
          }
          if (activeSong && activeSong !== song) {
            activeSong.stop();
            activeSong.card.classList.remove('active');
            activeSong.card.querySelector('button').classList.remove('is-active');
          }
          activeSong = song;
          card.classList.add('active');
          button.classList.add('is-active');
          button.textContent = 'Now playing';
          applyPeopleCount(peopleCount);
        } catch (err) {
          console.error(err);
          statusEl.textContent = 'Audio error: ' + err.message;
        }
      });
    });

    function applyPeopleCount(count) {
      peopleCount = count;
      countEl.textContent = count;
      const layerCopy = ['Core track only','Layer 1 engaged','Layers 1 + 2','All layers active'];
      layersEl.textContent = layerCopy[Math.min(count, 3)];
      if (activeSong) {
        activeSong.applyCount(count);
      }
    }

    async function startCamera() {
      if (stream) return;
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
        video.srcObject = stream;
        statusEl.textContent = 'Camera active. Analysing…';
        startBtn.disabled = true;
        await loadModel();
        scheduleDetection();
      } catch (err) {
        statusEl.textContent = 'Camera error: ' + err.message;
      }
    }

    async function loadModel() {
      if (!model) {
        statusEl.textContent = 'Loading detection model…';
        model = await cocoSsd.load({ base: 'lite_mobilenet_v2' });
        statusEl.textContent = 'Model ready. Step into frame to add layers.';
      }
    }

    async function analyze() {
      if (!model || video.readyState < 2) return;
      const predictions = await model.detect(video);
      const count = predictions.filter(p => p.class === 'person' && p.score >= 0.55).length;
      applyPeopleCount(count);
    }

    function scheduleDetection() {
      clearTimeout(detectionTimer);
      detectionTimer = setTimeout(async () => {
        try {
          await analyze();
        } catch (err) {
          console.error(err);
        }
        scheduleDetection();
      }, 260);
    }

    startBtn.addEventListener('click', startCamera);

    window.addEventListener('beforeunload', () => {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      songs.forEach(song => song.stop());
      audioContext.close();
    });
  </script>
</body>
</html>
