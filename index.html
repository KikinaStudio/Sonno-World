<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Sonno x World</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <script defer src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.13.0/dist/tf.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
  <style>
    @font-face {
      font-family:'TiemposHeadline';
      src:url('assets/fonts/Tiempos.otf') format('opentype');
      font-weight:400;
      font-style:normal;
      font-display:swap;
    }
    @font-face {
      font-family:'Lausanne';
      src:url('assets/fonts/Lausanne.woff') format('woff');
      font-weight:400;
      font-style:normal;
      font-display:swap;
    }
    :root {
      --bg:#f6f6f2;
      --pane:#ffffff;
      --border:rgba(15,17,26,0.1);
      --border-strong:rgba(15,17,26,0.16);
      --text:#0f111a;
      --muted:#646873;
      --accent:#6fdbed;
      --accent-soft:#4fb5c7;
      --radius:12px;
      --font-body:'Lausanne','Inter','Helvetica Neue',Arial,sans-serif;
      --font-heading:'TiemposHeadline','Times New Roman',serif;
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      font-family:var(--font-body);
      color:var(--text);
      background:var(--bg);
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:stretch;
      overflow-x:hidden;
    }
    .top-banner{
      width:100%;
      background:#eaecf0;
      border-bottom:1px solid rgba(15,17,26,0.08);
      color:var(--muted);
      font-size:11px;
      letter-spacing:0.32em;
      text-transform:uppercase;
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 32px;
    }
    .top-banner span{font-weight:500;}
    .top-banner img{height:30px;width:auto;}
    .hero{
      position:relative;
      flex:1;
      width:100%;
      display:flex;
      justify-content:center;
      align-items:flex-end;
      padding:0 32px;
    }
    .camera-frame{
      position:absolute;
      inset:0;
      border:none;
      border-radius:0;
      box-shadow:none;
      overflow:hidden;
      background:#0b1016;
    }
    video{width:100%;height:100%;object-fit:cover;transform:scaleX(-1);display:block;filter:saturate(0.92);}
    .overlay{
      position:absolute;
      inset:0;
      pointer-events:none;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      padding:20px 24px;
      background:linear-gradient(180deg,rgba(8,10,14,0) 55%,rgba(8,10,14,0.35) 100%);
    }
    .camera-hint{
      position:absolute;
      inset:50% auto auto 50%;
      transform:translate(-50%,-50%);
      background:rgba(12,16,24,0.62);
      color:#e4e8f3;
      padding:10px 18px;
      border-radius:999px;
      font-size:12px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      text-align:center;
      backdrop-filter:blur(10px);
      border:1px solid rgba(255,255,255,0.18);
      pointer-events:none;
    }
    .count{
      font-size:40px;
      font-weight:600;
      display:flex;
      flex-direction:column;
      gap:4px;
      color:#f5f6fa;
    }
    .count span{font-size:64px;line-height:0.95;color:#f5f6fa;}
    .count small{font-size:12px;letter-spacing:0.32em;text-transform:uppercase;color:rgba(245,246,250,0.8);}
    .layers-indicator{font-size:15px;font-weight:500;color:#f5f6fa;text-align:right;max-width:260px;line-height:1.4;}
    .control-panel{position:relative;z-index:2;width:min(740px,100%);border-radius:22px;padding:22px 28px;background:rgba(12,16,24,0.82);border:1px solid rgba(255,255,255,0.1);box-shadow:0 40px 120px rgba(8,10,16,0.45);backdrop-filter:blur(24px);display:flex;flex-direction:column;gap:20px;margin-bottom:4vh;}
    .control-panel .status{font-size:10px;color:#dfe3f1;text-align:left;letter-spacing:0.18em;text-transform:uppercase;}
    .control-panel .lede{font-size:14px;line-height:1.5;color:#c7ccd8;text-align:center;margin:0 auto;max-width:560px;}
    .simulation{max-width:680px;margin:0 auto 12px;display:flex;flex-direction:column;gap:8px;align-items:stretch;}
    .simulation label{font-size:11px;letter-spacing:0.24em;text-transform:uppercase;color:#dee3ef;}
    .simulation-toggle{display:flex;align-items:center;gap:12px;}
    .simulation-switch{display:flex;align-items:center;gap:8px;font-size:12px;letter-spacing:0.1em;text-transform:uppercase;color:#cbd2e0;font-weight:500;}
    .simulation-switch input{width:18px;height:18px;cursor:pointer;}
    .simulation-controls{display:flex;align-items:center;gap:12px;}
    #crowd-simulator{flex:1;-webkit-appearance:none;appearance:none;height:6px;border-radius:999px;background:linear-gradient(90deg,var(--accent) 0%,rgba(255,255,255,0.12) 100%);outline:none;}
    #crowd-simulator::-webkit-slider-thumb{
      -webkit-appearance:none;
      appearance:none;
      width:18px;
      height:18px;
      border-radius:50%;
      background:var(--accent);
      border:none;
      cursor:pointer;
    }
    #crowd-simulator::-moz-range-thumb{
      width:18px;
      height:18px;
      border-radius:50%;
      background:var(--accent);
      border:none;
      cursor:pointer;
    }
    .simulation-steps{display:flex;justify-content:space-between;font-size:11px;color:#9ca4b6;padding:0 4px;}
    .songs{display:flex;flex-wrap:wrap;gap:14px;justify-content:center;max-width:700px;margin:0 auto;}
    .song-card{padding:0;margin:0;border:none;background:transparent;}
    .song-card h3{display:none;}
    .song-trigger{display:flex;align-items:center;gap:12px;padding:14px 36px;border-radius:999px;border:1px solid rgba(255,255,255,0.14);background:#11151c;color:#f5f6fa;font-weight:500;letter-spacing:0.04em;text-transform:uppercase;font-size:11px;transition:border-color .2s ease,background .2s ease,color .2s ease;}
    .song-trigger .label{letter-spacing:0.04em;font-size:13px;text-transform:none;font-weight:500;}
    .song-trigger svg{width:16px;height:16px;fill:currentColor;}
    .song-trigger:hover{border-color:var(--accent);}
    .song-trigger.is-active{background:var(--accent);color:#0b1720;border-color:var(--accent);}
    footer{font-size:12px;color:var(--muted);text-align:center;letter-spacing:0.18em;text-transform:uppercase;}
    @media(max-width:720px){
      .top-banner{padding:10px 20px;font-size:10px;letter-spacing:0.26em;}
      .top-banner img{height:26px;}
      .hero{padding:36px 20px 0;}
      .panel{padding:32px 24px;}
    }
    @media(max-width:540px){
      .control-panel{padding:28px 24px;border-radius:20px;}
      .song-trigger{padding:16px 28px;}
    }
  </style>
</head>
<body>
  <div class="top-banner">
    <span>Sound with purpose</span>
    <img src="assets/Logo/World%20x%20Soono%20Logo.png" alt="Sonno x World logo" />
  </div>
  <header class="hero">
    <div class="camera-frame">
      <video id="webcam" autoplay playsinline muted></video>
      <div class="overlay">
        <div class="count"><span id="people-count">0</span><small>people in frame</small></div>
        <div class="layers-indicator" id="layers-indicator">Select a song to start playback.</div>
      </div>
      <div class="camera-hint">Camera will activate once a song starts playing.</div>
    </div>
    <div class="control-panel">
      <p class="status" id="camera-status">Camera idle. Choose a song to activate detection.</p>
      <div class="simulation">
        <div class="simulation-toggle">
          <label class="simulation-switch"><input type="checkbox" id="simulation-toggle" />Circle Population Simulation</label>
        </div>
        <div class="simulation-controls">
          <input id="crowd-simulator" type="range" min="0" max="3" step="1" value="0" aria-label="Circle population" title="Double-click to return to camera detection" />
          <span id="simulation-count" class="status" style="margin:0;min-width:52px;text-align:right;">0</span>
        </div>
        <div class="simulation-steps"><span>0</span><span>1</span><span>2</span><span>3+</span></div>
      </div>
      <div class="songs">
        <article class="song-card" data-song-id="world-1"
                 data-base="assets/audio/World%201/World%201%20(Drums).mp3|assets/audio/World%201/World%201%20(Synth).mp3"
                 data-group1="assets/audio/World%201/World%201%20(Percussion).mp3|assets/audio/World%201/World%201%20(Strings).mp3"
                 data-group2="assets/audio/World%201/World%201%20(Keyboard).mp3|assets/audio/World%201/World%201%20(FX).mp3"
                 data-group3="assets/audio/World%201/World%201%20(Vocals).mp3|assets/audio/World%201/World%201%20(Backing%20Vocals).mp3">
          <h3>World 1</h3>
          <button type="button" class="select-song song-trigger" aria-label="Toggle World 1 playback"></button>
        </article>

        <article class="song-card" data-song-id="world-2"
                 data-base="assets/audio/World%202/Close%20Enough%20to%20Touch%20(Keyboard).mp3|assets/audio/World%202/Close%20Enough%20to%20Touch%20(Synth).mp3"
                 data-group1="assets/audio/World%202/Close%20Enough%20to%20Touch%20(Bass).mp3"
                 data-group2="assets/audio/World%202/Close%20Enough%20to%20Touch%20(FX).mp3"
                 data-group3="assets/audio/World%202/Close%20Enough%20to%20Touch%20(Drums).mp3">
          <h3>World 2</h3>
          <button type="button" class="select-song song-trigger" aria-label="Toggle World 2 playback"></button>
        </article>

        <article class="song-card" data-song-id="world-3"
                 data-base="assets/audio/World%203/Paper%20Birds%20(Strings).mp3|assets/audio/World%203/Paper%20Birds%20(Keyboard).mp3"
                 data-group1="assets/audio/World%203/Paper%20Birds%20(Bass).mp3|assets/audio/World%203/Paper%20Birds%20(Synth).mp3"
                 data-group2="assets/audio/World%203/Paper%20Birds%20(FX).mp3"
                 data-group3="assets/audio/World%203/Paper%20Birds%20(Drums).mp3">
          <h3>World 3</h3>
          <button type="button" class="select-song song-trigger" aria-label="Toggle World 3 playback"></button>
        </article>
      </div>
      <p class="lede">This soundscape senses presence. Each person steps into the circle, unlocking new stems—turning single arrivals into a shared rhythm. The more we gather, the richer the music becomes.</p>
    </div>
  </header>

  <footer>Built for Sonno ∞ World — keep headphones handy.</footer>

  <script>
    const video = document.getElementById('webcam');
    const statusEl = document.getElementById('camera-status');
    const countEl = document.getElementById('people-count');
    const layersEl = document.getElementById('layers-indicator');
    const crowdSlider = document.getElementById('crowd-simulator');
    const simulationCountEl = document.getElementById('simulation-count');
    const simulationToggle = document.getElementById('simulation-toggle');

    let model = null;
    let stream = null;
    let detectionTimer = null;
    let cameraStartPromise = null;
    let peopleCount = 0;
    let manualOverride = false;

    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const masterGain = audioContext.createGain();
    masterGain.gain.value = 1;
    masterGain.connect(audioContext.destination);
    const songs = new Map();
    let activeSong = null;
    let isPaused = false;

    const pauseIcon = '<svg width="18" height="18" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg" fill="none"><rect x="4" y="3" width="3" height="12" rx="1" fill="currentColor"/><rect x="11" y="3" width="3" height="12" rx="1" fill="currentColor"/></svg>';
    const playIcon = '<svg width="18" height="18" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg" fill="none"><path d="M6.25 3.7c0-.78.85-1.26 1.52-.84l7 4.3c.66.4.66 1.36 0 1.76l-7 4.3a1 1 0 0 1-1.52-.84V3.7Z" fill="currentColor"/></svg>';

    class LoopPlayer {
      constructor(context, url, outputNode) {
        this.context = context;
        this.url = url;
        this.buffer = null;
        this.source = null;
        this.gain = context.createGain();
        this.outputNode = outputNode || context.destination;
        this.gain.connect(this.outputNode);
        this.gain.gain.value = 0;
      }
      async load() {
        const response = await fetch(this.url);
        if (!response.ok) throw new Error('Failed to load audio: ' + this.url);
        const data = await response.arrayBuffer();
        this.buffer = await this.context.decodeAudioData(data);
      }
      ensureSource() {
        if (this.source || !this.buffer) return;
        const node = this.context.createBufferSource();
        node.buffer = this.buffer;
        node.loop = true;
        node.connect(this.gain);
        node.start();
        this.source = node;
      }
      setActive(active, smooth = true) {
        this.ensureSource();
        const now = this.context.currentTime;
        this.gain.gain.cancelScheduledValues(now);
        if (!smooth) {
          this.gain.gain.setValueAtTime(active ? 1 : 0, now);
          return;
        }
        const target = active ? 1 : 0;
        const duration = active ? 1.5 : 0.5;
        this.gain.gain.setValueAtTime(this.gain.gain.value, now);
        this.gain.gain.linearRampToValueAtTime(target, now + duration);
      }
      stop() {
        const now = this.context.currentTime;
        this.gain.gain.cancelScheduledValues(now);
        this.gain.gain.setValueAtTime(0, now);
        if (this.source) {
          try { this.source.stop(); } catch (_) {}
          this.source.disconnect();
          this.source = null;
        }
      }
    }

    class SongLayers {
      constructor(context, card) {
        this.context = context;
        this.card = card;
        const dataset = card.dataset;
        const baseSources = dataset.base ? dataset.base.split('|').map(s => s.trim()).filter(Boolean)
          : (dataset.core ? [dataset.core] : []);
        this.basePlayers = baseSources.map(src => new LoopPlayer(context, src, masterGain));
        const groupKeys = Object.keys(dataset)
          .filter(key => /^group\d+$/.test(key))
          .sort((a, b) => Number(a.replace('group', '')) - Number(b.replace('group', '')));
        this.layerGroups = groupKeys.map(key => {
          return dataset[key]
            .split('|')
            .map(s => s.trim())
            .filter(Boolean)
            .map(src => new LoopPlayer(context, src, masterGain));
        });
        this.ready = false;
      }
      async load() {
        if (this.ready) return;
        const players = [
          ...this.basePlayers,
          ...this.layerGroups.flat()
        ];
        await Promise.all(players.map(p => p.load()));
        this.ready = true;
      }
      applyCount(count) {
        const groupsToActivate = Math.min(this.layerGroups.length, Math.max(0, count));
        const addedStemCount = this.layerGroups
          .slice(0, groupsToActivate)
          .reduce((sum, group) => sum + group.length, 0);
        if (!this.ready) {
          return {
            activeGroups: groupsToActivate,
            totalGroups: this.layerGroups.length,
            baseCount: this.basePlayers.length,
            addedStems: addedStemCount
          };
        }
        this.basePlayers.forEach(player => player.setActive(true, false));
        this.layerGroups.forEach((group, index) => {
          const shouldPlay = index < groupsToActivate;
          group.forEach(player => player.setActive(shouldPlay, true));
        });
        return {
          activeGroups: groupsToActivate,
          totalGroups: this.layerGroups.length,
          baseCount: this.basePlayers.length,
          addedStems: addedStemCount
        };
      }
      stop() {
        [...this.basePlayers, ...this.layerGroups.flat()].forEach(player => player.stop());
      }
    }

    function formatLayerStatus(activeGroups, totalGroups, baseCount, addedStems) {
      if (totalGroups === 0) {
        return baseCount > 0 ? 'Base stems active' : 'No stems loaded';
      }
      if (activeGroups === 0) {
        return baseCount > 0 ? 'Base stems only' : 'No stems active';
      }
      if (activeGroups >= totalGroups) {
        return 'All stems active';
      }
      return `Base + ${addedStems} added stems`;
    }

    function createToggle(button, song) {
      const label = song.card.querySelector('h3').textContent;
      button.dataset.label = label;
      updateButtonIcon(button, false);
      button.addEventListener('click', async () => {
        try {
          await ensureCameraStarted();
          await audioContext.resume();
          if (!song.ready) {
            button.setAttribute('aria-live','polite');
            button.textContent = 'Loading…';
            await song.load();
            button.textContent = '';
          }
          if (activeSong && activeSong !== song) {
            activeSong.stop();
            activeSong.card.classList.remove('active');
            const previousButton = activeSong.card.querySelector('.select-song');
            previousButton.classList.remove('is-active');
            updateButtonIcon(previousButton, false);
          }
          if (activeSong === song) {
            setPaused(!isPaused);
            return;
          }
          activeSong = song;
          song.card.classList.add('active');
          setPaused(false);
          if (manualOverride && crowdSlider) {
            const simulatedValue = Number(crowdSlider.value);
            const displayValue = simulatedValue === 3 ? '3+' : String(simulatedValue);
            applyPeopleCount(simulatedValue, { manual: true, display: displayValue });
          } else {
            applyPeopleCount(peopleCount);
          }
        } catch (err) {
          console.error(err);
          statusEl.textContent = 'Audio error: ' + err.message;
        }
      });
    }

    document.querySelectorAll('.song-card').forEach(card => {
      const song = new SongLayers(audioContext, card);
      songs.set(card.dataset.songId, song);
      const button = card.querySelector('.select-song');
      createToggle(button, song);
    });

    function applyPeopleCount(count, { manual = false, display = null } = {}) {
      if (!manual && manualOverride) return;
      peopleCount = count;
      countEl.textContent = display ?? count;
      if (manual) {
        statusEl.textContent = `Simulation: ${display ?? count}`;
      } else if (!isPaused && activeSong) {
        statusEl.textContent = 'Audio playing.';
      }
      if (!activeSong) {
        layersEl.textContent = 'Select a song to start playback.';
        updateAllIcons();
        return;
      }
      const { activeGroups, totalGroups, baseCount, addedStems } = activeSong.applyCount(count);
      layersEl.textContent = formatLayerStatus(activeGroups, totalGroups, baseCount, addedStems);
      updateAllIcons();
    }

    function setPaused(paused) {
      if (paused === isPaused) return;
      isPaused = paused;
      const now = audioContext.currentTime;
      masterGain.gain.cancelScheduledValues(now);
      masterGain.gain.setValueAtTime(masterGain.gain.value, now);
      masterGain.gain.linearRampToValueAtTime(paused ? 0 : 1, now + 0.25);
      if (manualOverride) {
        const simulatedLabel = simulationCountEl ? simulationCountEl.textContent : String(peopleCount);
        statusEl.textContent = paused ? `Simulation paused (${simulatedLabel})` : `Simulation: ${simulatedLabel}`;
      } else {
        statusEl.textContent = paused ? 'Audio paused.' : 'Audio playing.';
      }
      updateAllIcons();
    }

    function updateButtonIcon(button, isActive) {
      const label = button.dataset.label || '';
      const icon = (isPaused || !isActive) ? playIcon : pauseIcon;
      button.classList.toggle('is-active', isActive && !isPaused);
      button.innerHTML = icon + `<span class="label">${label}</span>`;
    }

    function updateAllIcons() {
      document.querySelectorAll('.song-card').forEach(card => {
        const button = card.querySelector('.select-song');
        const isThisActive = activeSong && activeSong.card === card && !isPaused;
        updateButtonIcon(button, isThisActive);
      });
    }

    async function ensureCameraStarted() {
      if (stream) return;
      if (!cameraStartPromise) {
        cameraStartPromise = startCamera().finally(() => {
          cameraStartPromise = null;
        });
      }
      return cameraStartPromise;
    }

    async function startCamera() {
      if (stream) return;
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
        video.srcObject = stream;
        statusEl.textContent = 'Camera active. Analysing…';
        await loadModel();
        scheduleDetection();
      } catch (err) {
        statusEl.textContent = 'Camera error: ' + err.message;
      }
    }

    async function loadModel() {
      if (!model) {
        statusEl.textContent = 'Loading detection model…';
        model = await cocoSsd.load({ base: 'lite_mobilenet_v2' });
        statusEl.textContent = 'Model ready. Step into frame to add layers.';
      }
    }

    async function analyze() {
      if (!model || video.readyState < 2 || manualOverride) return;
      const predictions = await model.detect(video);
      const count = predictions.filter(p => p.class === 'person' && p.score >= 0.55).length;
      applyPeopleCount(count);
    }

    function scheduleDetection() {
      clearTimeout(detectionTimer);
      detectionTimer = setTimeout(async () => {
        try {
          await analyze();
        } catch (err) {
          console.error(err);
        }
        scheduleDetection();
      }, 260);
    }

    if (simulationToggle) {
      simulationToggle.addEventListener('change', () => {
        manualOverride = simulationToggle.checked;
        if (manualOverride) {
          const value = crowdSlider ? Number(crowdSlider.value) : 0;
          const displayValue = value === 3 ? '3+' : String(value);
          if (simulationCountEl) simulationCountEl.textContent = displayValue;
          applyPeopleCount(value, { manual: true, display: displayValue });
        } else {
          statusEl.textContent = stream ? 'Camera active. Analysing…' : 'Camera idle. Choose a song to activate detection.';
          applyPeopleCount(peopleCount);
        }
      });
    }

    if (crowdSlider) {
      crowdSlider.addEventListener('input', (event) => {
        const value = Number(event.target.value);
        manualOverride = true;
        if (simulationToggle) simulationToggle.checked = true;
        const displayValue = value === 3 ? '3+' : String(value);
        if (simulationCountEl) simulationCountEl.textContent = displayValue;
        applyPeopleCount(value, { manual: true, display: displayValue });
      });
      crowdSlider.addEventListener('dblclick', () => {
        manualOverride = false;
        crowdSlider.value = '0';
        if (simulationCountEl) simulationCountEl.textContent = '0';
        if (simulationToggle) simulationToggle.checked = false;
        statusEl.textContent = stream ? 'Camera active. Analysing…' : 'Camera idle. Choose a song to activate detection.';
        applyPeopleCount(peopleCount);
      });
    }

    window.addEventListener('beforeunload', () => {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      songs.forEach(song => song.stop());
      audioContext.close();
    });
  </script>
</body>
</html>
